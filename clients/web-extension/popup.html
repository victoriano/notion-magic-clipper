<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Notion Magic Clipper</title>
    <style>
      :root {
        --background: #ffffff;
        --foreground: #0a0a0a;
        --muted: #f5f5f5;
        --muted-foreground: #6b7280;
        --card: #ffffff;
        --card-foreground: #0a0a0a;
        --border: #e5e7eb;
        --input: #e5e7eb;
        --ring: #64C5FD;
        --primary: #64C5FD;
        --primary-foreground: #000000;
        --secondary: #f3f4f6;
        --secondary-foreground: #0a0a0a;
        --radius: 12px;
        color-scheme: light;
      }
      * { box-sizing: border-box; }
      body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; margin: 12px 12px 8px 12px; min-width: 300px; background: var(--background); color: var(--foreground); }
      .row { display: flex; gap: 8px; align-items: center; }
      label { display: block; margin: 8px 0 4px; font-weight: 600; color: var(--foreground); }
      small { color: var(--muted-foreground); }
      #status { margin-top: 12px; min-height: 1.2em; }
      a { color: var(--primary); }
      .card { background: var(--card); color: var(--card-foreground); border: none; border-radius: 0; box-shadow: none; padding: 12px 12px 8px 12px; }
      .title { margin: 0; display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; letter-spacing: 0.01em; }
      .app-title { margin: 0; display: flex; align-items: center; gap: 10px; font-size: 18px; font-weight: 700; letter-spacing: 0.01em; }
      /* Inputs */
      select, input, textarea { width: 100%; padding: 8px 10px; font-size: 14px; color: var(--foreground); background: var(--card); border: 1px solid var(--input); border-radius: 10px; }
      textarea { min-height: 64px; }
      select:focus, input:focus, textarea:focus, .combobox-trigger:focus { outline: 2px solid var(--ring); outline-offset: 2px; }
      .link { color: var(--primary); cursor: pointer; text-decoration: underline; }
      .error { color: #ef4444; }
      .success { color: #16a34a; }
      /* Buttons */
      button { cursor: pointer; }
      .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; border-radius: 10px; border: 1px solid var(--border); background: var(--secondary); color: var(--secondary-foreground); padding: 8px 10px; font-size: 14px; line-height: 1; }
      .btn:hover { filter: brightness(0.98); }
      .btn-primary { background: var(--primary); color: var(--primary-foreground); border-color: var(--primary); }
      .btn-primary:hover { filter: brightness(0.96); }
      .btn-outline { background: transparent; color: var(--foreground); }
      .btn-ghost { background: transparent; border-color: transparent; color: var(--primary); padding: 0; }
      .icon-button { background: transparent; border: none; color: var(--foreground); }
      .icon-button svg { width: 18px; height: 18px; stroke: currentColor; }
      /* Notion-like primary button and hint */
      .btn-primary { background: var(--primary); border-color: var(--primary); }
      .btn-primary:hover { filter: none; background: #56BCFB; border-color: #56BCFB; }
      .kbd-hint { color: var(--muted-foreground); font-size: 12px; margin-left: 8px; align-self: center; }
      /* Settings indicator (gear) */
      .indicator { background: transparent; border: none; padding: 4px; border-radius: 8px; color: var(--foreground); cursor: pointer; }
      .indicator svg { width: 18px; height: 18px; stroke: currentColor; }
      .indicator.ok { color: #16a34a; }
      .indicator.err { color: #dc2626; }
      /* Combobox (shadcn-like) */
      .combobox { position: relative; width: 100%; }
      .combobox-trigger { width: 100%; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--input); border-radius: 10px; background: var(--card); color: var(--foreground); padding: 8px 10px; }
      .combobox-trigger .chevron { opacity: 0.6; }
      .cbx-dropdown { position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 12px 32px rgba(0,0,0,0.18); z-index: 1000; display: none; }
      .cbx-search-wrapper { padding: 6px; border-bottom: 1px solid var(--border); background: var(--card); border-top-left-radius: 12px; border-top-right-radius: 12px; }
      .cbx-search { width: 100%; padding: 8px 10px; border: 1px solid var(--input); border-radius: 10px; background: var(--background); color: var(--foreground); }
      .cbx-list { max-height: 240px; overflow: auto; padding: 6px 0; }
      .cbx-item { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 8px 10px; cursor: pointer; border-radius: 8px; }
      .cbx-item:hover { background: var(--muted); }
      .cbx-check { opacity: 0; }
      .cbx-item[aria-selected="true"] .cbx-check { opacity: 1; }
      .cbx-empty { padding: 10px; color: var(--muted-foreground); }
      /* --- DB Settings page polish --- */
      .section-title { margin: 10px 0 6px; font-size: 15px; font-weight: 700; }
      #dbsPrompt, #dbsContentPrompt { background: var(--background); }
      #dbsSaveArticleLabel, #dbsCustomizeLabel { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
      #dbsSaveArticleLabel span, #dbsCustomizeLabel span { display: inline-flex; flex-direction: column; line-height: 1.2; }
      .toggle-text { font-weight: 600; }
      .toggle-hint { font-weight: 400; font-size: 12px; color: var(--muted-foreground); }
      input.switch { appearance: none; -webkit-appearance: none; width: 42px; height: 24px; background: var(--input); border: 1px solid var(--border); border-radius: 999px; position: relative; cursor: pointer; transition: background .2s, border-color .2s; }
      input.switch::after { content: ""; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: #ffffff; border-radius: 999px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); transition: left .2s; }
      input.switch:checked { background: var(--primary); border-color: var(--primary); }
      input.switch:checked::after { left: 20px; }
      .actions { margin-top: 10px; }
      .actions .btn { padding: 10px 14px; height: 36px; }
      #dbsStatus { margin-top: 12px; color: var(--muted-foreground); }
      #dbsStatus.success { color: #16a34a; }
      /* Tokens page status */
      #tokensStatus { margin-top: 12px; color: var(--muted-foreground); }
      /* Tokens view spacing & separators */
      #tokensView small { display: block; margin-top: 6px; margin-bottom: 8px; }
      .divider { height: 1px; background: var(--border); border: 0; margin: 14px 0; }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 14px">
        <h3 class="app-title">
          <img src="icons/Clip Logo Chrome White.svg" alt="" style="height:22px; width:22px"/>
          Notion Magic Clipper
        </h3>
        <button id="statusIndicator" class="indicator" title="Checking tokens…" aria-label="Token status">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 7.04 3.4l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .66.26 1.3.73 1.77.47.47 1.11.73 1.77.73H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
          </svg>
        </button>
      </div>
      <div id="precheck" style="display:none"></div>
      <div id="app" style="display:none">
        <div class="row" style="margin-top:8px">
          <div class="combobox" id="dbCombobox">
            <button id="dbComboTrigger" class="combobox-trigger" aria-expanded="false">
              <span id="dbComboLabel">Loading databases...</span>
              <span class="chevron">▾</span>
            </button>
            <div id="dbComboDropdown" class="cbx-dropdown" role="listbox" aria-hidden="true">
              <div class="cbx-search-wrapper">
                <input id="dbComboSearch" class="cbx-search" placeholder="Search database..." />
              </div>
              <div id="dbComboList" class="cbx-list"></div>
              <div id="dbComboEmpty" class="cbx-empty" style="display:none">No databases found.</div>
            </div>
          </div>
        </div>
        <div id="customSaveRow" style="margin-top:10px; display:none">
          <div class="row" style="justify-content: space-between; align-items: center">
            <button id="openDbSettings" class="btn btn-ghost" style="width:auto; display:inline-flex; align-items:center; gap:6px; color: var(--primary); text-decoration: none">
              <svg width="18" height="18" viewBox="0 0 213 213" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" style="fill: currentColor">
                <path fill="currentColor" d="M196.794 102.235H73.7784V95.5913C73.7784 88.2586 67.812 82.3043 60.4829 82.3043C53.1455 82.3043 47.1875 88.2669 47.1875 95.5913V102.235H17.2568C12.9273 102.293 12.8527 108.804 17.2568 108.878H47.179V115.522C47.179 122.855 53.1453 128.809 60.4744 128.809C67.8118 128.809 73.7699 122.846 73.7699 115.522V108.878H196.786C201.057 108.837 201.24 102.31 196.786 102.235H196.794ZM67.1307 115.522C66.898 124.275 54.0596 124.291 53.8352 115.522V95.5831C53.8352 91.9207 56.8183 88.9395 60.4829 88.9395C64.1476 88.9395 67.1307 91.9207 67.1307 95.5831V115.522Z"/>
                <path fill="currentColor" d="M196.794 155.398H166.872V148.754C166.315 131.191 140.83 131.191 140.273 148.754V155.398H17.2568C15.4203 155.398 13.9329 156.884 13.9329 158.72C13.9329 160.555 15.4203 162.041 17.2568 162.041H140.273V168.685C140.273 176.018 146.239 181.972 153.568 181.972C160.906 181.972 166.864 176.009 166.864 168.685V162.041H196.786C201.115 161.983 201.19 155.473 196.786 155.398H196.794ZM160.224 168.685C159.992 177.438 147.153 177.454 146.929 168.685V148.746C146.929 145.084 149.912 142.103 153.577 142.103C157.241 142.103 160.224 145.084 160.224 148.746V168.685Z"/>
                <path fill="currentColor" d="M17.2557 55.7132H140.272V62.3568C140.272 69.6895 146.238 75.6438 153.567 75.6438C160.904 75.6438 166.863 69.6812 166.863 62.3568V55.7132H196.785C201.114 55.6551 201.189 49.1445 196.785 49.0697H166.863V42.4262C166.863 35.0935 160.896 29.1392 153.567 29.1392C146.23 29.1392 140.272 35.1017 140.272 42.4262V49.0697H17.2557C12.9845 49.1112 12.8016 55.6384 17.2557 55.7132ZM146.919 42.4262C147.152 33.6733 159.99 33.6568 160.215 42.4262V62.365C160.215 66.0274 157.232 69.0086 153.567 69.0086C149.902 69.0086 146.919 66.0274 146.919 62.365V42.4262Z"/>
              </svg>
              <span id="openDbSettingsLabel">Custom save format</span>
            </button>
            <button id="toggleNoteBtn" class="icon-button" title="Add extra context for the AI" aria-label="Add extra context for the AI">
              <img src="icons/extra_context.svg" alt="Add extra context for the AI" style="width:18px;height:18px;opacity:.9"/>
            </button>
          </div>
        </div>
        <div id="noteRow" style="margin-top:8px; display:none">
          <textarea id="note" placeholder="Optional extra context for the AI"></textarea>
        </div>
        <div id="saveRow" class="row" style="margin-top:14px; display:none">
          <button id="save" class="btn btn-primary">Save to Notion</button>
          <span class="kbd-hint">Intro</span>
        </div>
        <div id="status"></div>
      </div>

      <div id="historyView" style="display:none">
        <h3 class="title">Recent saves</h3>
        <div id="historyStatus"></div>
        <ul id="historyList"></ul>
        <div class="row" style="margin-top:8px">
          <button id="backToMain" class="btn">← Back</button>
          <button id="clearHistory" class="btn btn-outline" style="width:auto">Clear</button>
        </div>
      </div>
      <div id="untitledView" style="display:none">
        <h3 class="title">Untitled databases</h3>
        <div id="untitledStatus"></div>
        <ul id="untitledList"></ul>
        <div class="row" style="margin-top:8px">
          <button id="untitledBack" class="btn">← Back</button>
        </div>
      </div>
      <div id="tokensView" style="display:none">
        <h3 class="title">Tokens</h3>
        <div id="accountRow" class="row" style="margin:8px 0; justify-content: space-between">
          <div id="accountInfo" style="font-size:13px; color: var(--muted-foreground)">Not logged in</div>
          <div class="row" style="gap:10px">
            <button id="startNotionLogin" class="btn btn-primary" style="width:auto">Login with Notion</button>
            <button id="logoutBtn" class="btn btn-outline" style="width:auto; display:none">Logout</button>
          </div>
        </div>
        <!-- Legacy token input hidden by default; keep for dev/testing -->
        <div id="legacyToken" style="display:none">
          <label for="tNotionToken">Notion Integration Token</label>
          <input id="tNotionToken" type="password" placeholder="secret_..." />
          <small>
            Create an <b>Internal Integration</b> and copy its token:
            <a href="https://www.notion.so/my-integrations" target="_blank" rel="noreferrer">my-integrations</a>.
            Then share your databases with that integration. Docs:
            <a href="https://www.notion.com/help/create-integrations-with-the-notion-api" target="_blank" rel="noreferrer">Notion Help</a>.
          </small>
        </div>
        <div class="row" style="margin-top:8px; align-items: flex-end; display:none" id="advancedBackendRow">
          <div style="flex:1">
            <label for="tWorkspaceId">Workspace ID (from redirect)</label>
            <input id="tWorkspaceId" type="text" placeholder="a5c3b78f-..." />
          </div>
          <button id="fetchTokenFromBackend" class="btn" style="width:auto">Fetch from backend</button>
        </div>
        <div id="advancedBackendUrl" style="display:none">
          <label for="tBackendUrl">Backend URL (for Notion OAuth)</label>
          <input id="tBackendUrl" type="text" placeholder="http://localhost:3000" />
          <small>Points to your OAuth backend (Next.js app). Example: <code>http://localhost:3000</code>.</small>
        </div>
        <hr class="divider" />
        <div>
          <label class="section-title">Linked workspaces</label>
          <ul id="linkedWorkspaces" style="margin:6px 0 10px; padding-left: 16px"></ul>
          <div class="row" style="margin:10px 0 6px">
            <button id="connectWorkspaceBtn" class="btn btn-primary" style="width:auto; display:none">Connect another workspace</button>
          </div>
        </div>
        <hr class="divider" />
        <label for="tModel">Model</label>
        <select id="tModel"></select>
        <small>Pick the model to use. In production, the server provides the keys.</small>
        <div id="gpt5Options" style="display:none; margin-top:8px">
          <label class="section-title">GPT‑5 options</label>
          <div class="row" style="gap:10px">
            <div style="flex:1">
              <label for="tGpt5Reasoning">Reasoning effort</label>
              <select id="tGpt5Reasoning">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div style="flex:1">
              <label for="tGpt5Verbosity">Verbosity</label>
              <select id="tGpt5Verbosity">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>
          <small>These options apply to OpenAI GPT‑5 models only.</small>
        </div>
        <hr class="divider" />
        <div class="row" style="margin-top:8px">
          <button id="dbIndexRefresh" class="btn btn-ghost" style="width:auto; display:inline-flex; align-items:center; gap:6px">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="width:18px;height:18px">
              <polyline points="23 4 23 10 17 10"/>
              <polyline points="1 20 1 14 7 14"/>
              <path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10M1 14l5.36 4.36A9 9 0 0 0 20.49 15"/>
            </svg>
            Refresh databases
          </button>
        </div>
        <div class="row" style="margin-top:6px">
          <button id="tokensClear" class="btn btn-ghost" style="width:auto; display:inline-flex; align-items:center; gap:6px" title="Temporarily for testing">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="width:18px;height:18px">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
              <path d="M10 11v6"/>
              <path d="M14 11v6"/>
              <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
            </svg>
            Clear local data
          </button>
        </div>
        <div class="row" style="margin-top:6px">
          <button id="openUntitled" class="btn btn-ghost" style="width:auto; display:inline-flex; align-items:center; gap:6px">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="width:18px;height:18px">
              <circle cx="11" cy="11" r="8"/>
              <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            List untitled databases
          </button>
        </div>
        <div class="row" style="margin-top:6px">
          <button id="openHistory" class="btn btn-ghost" style="width:auto; display:inline-flex; align-items:center; gap:6px">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="width:18px;height:18px">
              <path d="M3 3v5h5"/>
              <path d="M3.05 13A9 9 0 1 0 8 3"/>
              <path d="M12 7v5l4 2"/>
            </svg>
            Recent saves
          </button>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="tokensBack" class="btn">← Back</button>
          <button id="tokensSave" class="btn btn-primary" style="width:auto">Save</button>
        </div>
        <div id="tokensStatus"></div>
        
      </div>
      <div id="dbSettingsView" style="display:none">
        <h3 class="title">Database settings</h3>
        <div id="dbSettingsDbName" style="margin-bottom:10px; color: var(--foreground); font-size: 16px; font-weight: 700"></div>
        <label for="dbsPrompt" class="section-title">Custom instructions</label>
        <textarea id="dbsPrompt" rows="4" style="width:100%" placeholder="Custom instructions for this database (how to map, which properties to prioritize, etc.)"></textarea>
        <label id="dbsSaveArticleLabel">
          <input id="dbsSaveArticle" class="switch" type="checkbox" />
          <span><span class="toggle-text">Save article content as page content</span><span class="toggle-hint">default on</span></span>
        </label>
        <label id="dbsCustomizeLabel" style="display:none">
          <input id="dbsCustomize" class="switch" type="checkbox" />
          <span class="toggle-text">Customize content page</span>
        </label>
        <textarea id="dbsContentPrompt" rows="5" style="width:100%; display:none" placeholder="Content customization for article children (e.g., write a concise summary with key points, extract pricing table, etc.)"></textarea>
        <div class="row actions">
          <button id="dbsBack" class="btn">← Back</button>
          <button id="dbsSave" class="btn btn-primary" style="width:auto">Save</button>
          <button id="dbsClear" class="btn btn-outline" style="width:auto">Clear</button>
        </div>
        <div id="dbsStatus"></div>
      </div>
    </div>
    <script src="popup.js" type="module"></script>
  </body>
</html>
